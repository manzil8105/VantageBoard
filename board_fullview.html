<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>VantageBoard</title>
    <link rel="stylesheet" href="style1.css" />
    <style>
      /* LAYOUT */
      .board-layout {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        height: calc(100vh - 100px);
        overflow: hidden;
        padding: 20px;
      }
      .kanban-scroll-area {
        overflow-x: auto;
        height: 100%;
        padding-bottom: 10px;
      }
      .kanban {
        display: flex;
        gap: 15px;
        height: 100%;
        min-width: 100%;
      }
      .column {
        flex: 0 0 280px;
        background: rgba(0, 0, 0, 0.25);
        border-radius: 8px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .task-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 4px;
        min-height: 50px;
      }

      /* task card */
      .task {
        background: #2a2a2a;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        position: relative;
      }
      .task:hover {
        transform: translateY(-2px);
        border-color: #777;
      }

      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .tick-btn {
        width: 18px;
        height: 18px;
        border: 2px solid #666;
        border-radius: 50%;
        cursor: pointer;
        margin-left: 8px;
        flex-shrink: 0;
      }
      .tick-btn:hover {
        border-color: #00ff00;
        background: rgba(0, 255, 0, 0.1);
      }

      /* DEFCON BORDERS */
      .defcon-5 {
        border-left: 4px solid #00ff00;
      }
      .defcon-4 {
        border-left: 4px solid #adff2f;
      }
      .defcon-3 {
        border-left: 4px solid #ffff00;
      }
      .defcon-2 {
        border-left: 4px solid #ffa500;
      }
      .defcon-1 {
        border-left: 4px solid #ff0000;
      }

      /* DEADLINE WARNINGS */
      .task.overdue {
        border: 2px solid #ff4444 !important;
      }
      .task.nearing {
        border: 2px solid orange !important;
      }
      .date-badge {
        font-size: 10px;
        background: #444;
        padding: 2px 4px;
        border-radius: 3px;
        margin-top: 3px;
        display: inline-block;
      }

      /* sidebar */
      .right-sidebar {
        background: rgba(0, 0, 0, 0.2);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        padding: 20px;
        overflow-y: auto;
      }
      .sidebar-title {
        font-size: 12px;
        text-transform: uppercase;
        color: #888;
        margin-bottom: 5px;
        margin-top: 20px;
      }
      .desc-text {
        color: #ddd;
        white-space: pre-wrap;
        font-size: 14px;
      }
      .tag {
        background: #444;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-right: 5px;
      }
      .link-item {
        display: block;
        color: #d96a73;
        margin-bottom: 5px;
        text-decoration: none;
        font-size: 14px;
      }
      .link-item:hover {
        text-decoration: underline;
      }

      /* modal */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 100;
        align-items: center;
        justify-content: center;
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: #1e1e1e;
        padding: 25px;
        border-radius: 12px;
        width: 450px;
        border: 1px solid #333;
      }

      /* Link badge */
      .link-badge {
        background: #890111;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-right: 5px;
        display: inline-flex;
        align-items: center;
      }
      .link-badge .remove-link {
        margin-left: 5px;
        cursor: pointer;
        font-size: 10px;
        color: #ddd;
      }
      .link-badge .remove-link:hover {
        color: #fff;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div
        class="brand"
        onclick="window.location.href = 'dashboard.html'"
        style="cursor: pointer"
      >
        <div class="logo">SL</div>
        <div class="logo-large" id="boardTitleNav">Loading...</div>
      </div>
      <nav class="nav">
        <button class="btn ghost small" onclick="openEditBoardModal()">
          Edit Board
        </button>
        <button class="btn small" onclick="openInviteModal()">Invite +</button>
        <a class="muted" href="dashboard.html">Back to Dashboard</a>
      </nav>
    </header>

    <div class="board-layout">
      <div class="kanban-scroll-area">
        <div class="kanban" id="kanbanContainer"></div>
      </div>

      <aside class="right-sidebar">
        <h2 id="sbTitle" class="h2">Board Details</h2>

        <div class="sidebar-title">Description</div>
        <p id="sbDesc" class="desc-text">No description provided.</p>

        <div class="sidebar-title">Tags</div>
        <div id="sbTags"></div>

        <div class="sidebar-title">External Links</div>
        <div id="sbLinks"></div>

        <div class="sidebar-title">Team Members</div>
        <div id="sbMembers" style="font-size: 13px; color: #aaa"></div>
      </aside>
    </div>

    <div id="addTaskModal" class="modal">
      <div class="modal-content">
        <h3>Add New Task</h3>
        <input type="hidden" id="newTaskColumnId" />
        <div class="form-group">
          <label class="small">Title</label
          ><input class="input" id="newTaskTitle" />
        </div>
        <div class="form-group">
          <label class="small">Priority</label>
          <select class="input" id="newTaskPriority">
            <option value="5">DEFCON 5 - Normal</option>
            <option value="4">DEFCON 4 - Increased Watch</option>
            <option value="3">DEFCON 3 - Round House</option>
            <option value="2">DEFCON 2 - Fast Pace</option>
            <option value="1">DEFCON 1 - Cocked Pistol</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px">
          <div class="form-group" style="flex: 1">
            <label class="small">Start Date</label
            ><input type="date" class="input" id="newTaskStart" />
          </div>
          <div class="form-group" style="flex: 1">
            <label class="small">Deadline</label
            ><input type="date" class="input" id="newTaskDue" />
          </div>
        </div>

        <div class="form-group">
          <label class="small">Depends On (Optional)</label>
          <input
            class="input"
            id="newTaskDependency"
            placeholder="Enter Exact Task Title"
          />
        </div>

        <div class="form-group">
          <label class="small">Assignee (Email)</label
          ><input class="input" id="newTaskAssignee" />
        </div>
        <div class="form-group">
          <label class="small">Description</label
          ><textarea class="input" id="newTaskDesc" rows="3"></textarea>
        </div>
        <div style="margin-top: 15px; text-align: right">
          <button class="btn ghost" onclick="closeModal('addTaskModal')">
            Cancel
          </button>
          <button class="btn" onclick="submitNewTask()">Save Task</button>
        </div>
      </div>
    </div>

    <div id="editTaskModal" class="modal">
      <div class="modal-content">
        <h3>Edit Task</h3>
        <input type="hidden" id="editTaskId" />
        <div class="form-group">
          <label class="small">Title</label
          ><input class="input" id="editTaskTitle" />
        </div>
        <div class="form-group">
          <label class="small">Priority</label>
          <select class="input" id="editTaskPriority">
            <option value="5">DEFCON 5</option>
            <option value="4">DEFCON 4</option>
            <option value="3">DEFCON 3</option>
            <option value="2">DEFCON 2</option>
            <option value="1">DEFCON 1</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px">
          <div class="form-group" style="flex: 1">
            <label class="small">Start Date</label
            ><input type="date" class="input" id="editTaskStart" />
          </div>
          <div class="form-group" style="flex: 1">
            <label class="small">Deadline</label
            ><input type="date" class="input" id="editTaskDue" />
          </div>
        </div>
        <div class="form-group">
          <label class="small">Description</label
          ><textarea class="input" id="editTaskDesc" rows="4"></textarea>
        </div>
        <div
          style="
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
          "
        >
          <button class="btn danger small" onclick="deleteTask()">
            Delete Task
          </button>
          <div>
            <button class="btn ghost" onclick="closeModal('editTaskModal')">
              Cancel
            </button>
            <button class="btn" onclick="updateTask()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <div id="editBoardModal" class="modal">
      <div class="modal-content">
        <h3>Edit Board</h3>
        <div class="form-group">
          <label class="small">Name</label><input class="input" id="ebTitle" />
        </div>
        <div class="form-group">
          <label class="small">Description</label
          ><textarea class="input" id="ebDesc"></textarea>
        </div>
        <div class="form-group">
          <label class="small">Tags</label><input class="input" id="ebTags" />
        </div>

        <label class="small">External Links</label>
        <div style="display: flex; gap: 5px; margin-bottom: 5px">
          <input
            class="input"
            id="linkName"
            placeholder="Name (e.g. Facebook)"
            style="flex: 1"
          />
          <input class="input" id="linkUrl" placeholder="URL" style="flex: 2" />
          <button class="btn ghost small" onclick="addLink()">+</button>
        </div>
        <div id="linkList" style="margin-bottom: 15px"></div>

        <div style="margin-top: 15px; text-align: right">
          <button class="btn ghost" onclick="closeModal('editBoardModal')">
            Cancel
          </button>
          <button class="btn" onclick="saveBoardEdit()">Update Board</button>
        </div>
      </div>
    </div>

    <div id="inviteModal" class="modal">
      <div class="modal-content">
        <h3>Invite Member</h3>
        <div class="form-group">
          <label class="small">User Email</label
          ><input class="input" id="inviteEmail" />
        </div>
        <div style="margin-top: 15px; text-align: right">
          <button class="btn ghost" onclick="closeModal('inviteModal')">
            Cancel
          </button>
          <button class="btn" onclick="submitInvite()">Invite</button>
        </div>
      </div>
    </div>

    <script>
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) window.location.href = "login.html";

      const params = new URLSearchParams(window.location.search);
      const boardId = params.get("id");
      let boardData = null;
      let currentLinks = [];

      if (!boardId) window.location.href = "dashboard.html";

      async function loadData() {
        const res = await fetch(
          `http://localhost:3000/board-details/${boardId}`,
        );
        if (!res.ok) {
          alert("Board not found");
          return;
        }
        boardData = await res.json();

        // Update Header & Sidebar
        document.getElementById("boardTitleNav").innerText =
          boardData.board.boardtitle;
        document.getElementById("sbTitle").innerText =
          boardData.board.boardtitle;
        document.getElementById("sbDesc").innerText =
          boardData.board.description || "No description.";

        const tagsBox = document.getElementById("sbTags");
        tagsBox.innerHTML = boardData.board.tags
          ? boardData.board.tags
              .split(",")
              .map((t) => `<span class="tag">${t.trim()}</span>`)
              .join("")
          : "None";

        const linksBox = document.getElementById("sbLinks");
        linksBox.innerHTML =
          boardData.links.length > 0
            ? boardData.links
                .map(
                  (l) =>
                    `<a href="${l.link_url}" class="link-item" target="_blank">ðŸ”— ${l.link_name}</a>`,
                )
                .join("")
            : "No links.";

        const membersBox = document.getElementById("sbMembers");
        membersBox.innerHTML = boardData.members
          .map((m) => `<div>â€¢ ${m.username} (${m.email})</div>`)
          .join("");

        renderKanban(boardData.columns, boardData.tasks);
      }

      function renderKanban(columns, tasks) {
        const container = document.getElementById("kanbanContainer");
        container.innerHTML = "";

        columns.forEach((col) => {
          const colDiv = document.createElement("div");
          colDiv.className = "column";
          colDiv.innerHTML = `<div class="h2" style="font-size:16px; margin-bottom:10px; border-bottom: 1px solid #444; padding-bottom:5px;">${col.title}</div>`;

          colDiv.ondragover = (e) => e.preventDefault();
          colDiv.ondrop = (e) => dropTask(e, col.id);

          const taskList = document.createElement("div");
          taskList.className = "task-list";

          const colTasks = tasks.filter((t) => t.column_id === col.id);
          colTasks.forEach((t) => {
            const task = document.createElement("div");

            let dateClass = "";
            let dateText = "";
            if (t.due_date) {
              const due = new Date(t.due_date);
              const now = new Date();
              const diff = (due - now) / (1000 * 60 * 60 * 24);
              dateText = `<div class="date-badge">Due: ${due.toLocaleDateString()}</div>`;
              if (diff < 0 && col.title !== "Done") dateClass = "overdue";
              else if (diff < 2 && col.title !== "Done") dateClass = "nearing";
            }

            task.className = `task defcon-${t.priority} ${dateClass}`;
            task.draggable = true;
            task.ondragstart = (e) => e.dataTransfer.setData("taskId", t.id);
            task.onclick = (e) => {
              if (!e.target.classList.contains("tick-btn"))
                openEditTaskModal(t);
            };

            task.innerHTML = `
            <div class="task-header">
              <div style="font-weight:600; color:#fff;">#${t.id} ${t.title}</div>
              <div class="tick-btn" onclick="advanceTask(${t.id}, '${col.title}')" title="Advance"></div>
            </div>
            ${dateText}
            <div style="font-size:11px; color:#aaa; margin-top:5px;">
              ${t.assignee_name ? `<span style="color:#8fd3f4">ðŸ‘¤ ${t.assignee_name}</span>` : "Unassigned"}
            </div>
          `;
            taskList.appendChild(task);
          });

          colDiv.appendChild(taskList);
          const addBtn = document.createElement("button");
          addBtn.className = "btn ghost small";
          addBtn.innerText = "+ Add Task";
          addBtn.onclick = () => {
            document.getElementById("newTaskColumnId").value = col.id;
            document.getElementById("addTaskModal").classList.add("show");
          };
          colDiv.appendChild(addBtn);
          container.appendChild(colDiv);
        });
      }

      async function dropTask(e, colId) {
        const taskId = e.dataTransfer.getData("taskId");
        const res = await fetch("http://localhost:3000/move-task", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ taskId, targetColumnId: colId }),
        });
        if (res.status === 403) {
          const d = await res.json();
          alert(d.error);
        }
        loadData();
      }

      async function advanceTask(id, currentTitle) {
        const res = await fetch("http://localhost:3000/advance-task", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            taskId: id,
            currentColumnTitle: currentTitle,
            boardId,
          }),
        });
        if (res.status === 403) {
          const d = await res.json();
          alert("ðŸš« " + d.error);
        } else loadData();
      }

      //sends "dependsOn" (task title) to the server
      async function submitNewTask() {
        const payload = {
          boardId,
          columnId: document.getElementById("newTaskColumnId").value,
          title: document.getElementById("newTaskTitle").value,
          priority: document.getElementById("newTaskPriority").value,
          description: document.getElementById("newTaskDesc").value,
          assigneeEmail: document.getElementById("newTaskAssignee").value,
          startDate: document.getElementById("newTaskStart").value,
          dueDate: document.getElementById("newTaskDue").value,
          dependsOn: document.getElementById("newTaskDependency").value, // New Field
        };

        const res = await fetch("http://localhost:3000/create-task", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (res.ok) {
          closeModal("addTaskModal");
          document.getElementById("newTaskTitle").value = "";
          document.getElementById("newTaskDesc").value = "";
          document.getElementById("newTaskAssignee").value = "";
          document.getElementById("newTaskStart").value = "";
          document.getElementById("newTaskDue").value = "";
          document.getElementById("newTaskDependency").value = ""; // Clear Dependency Input
          loadData();
        } else {
          const d = await res.json();
          alert(d.msg);
        }
      }

      function openEditTaskModal(t) {
        document.getElementById("editTaskId").value = t.id;
        document.getElementById("editTaskTitle").value = t.title;
        document.getElementById("editTaskPriority").value = t.priority;
        document.getElementById("editTaskDesc").value = t.description;
        document.getElementById("editTaskStart").value = t.start_date
          ? t.start_date.split("T")[0]
          : "";
        document.getElementById("editTaskDue").value = t.due_date
          ? t.due_date.split("T")[0]
          : "";
        document.getElementById("editTaskModal").classList.add("show");
      }

      async function updateTask() {
        const taskId = document.getElementById("editTaskId").value;
        const payload = {
          title: document.getElementById("editTaskTitle").value,
          description: document.getElementById("editTaskDesc").value,
          priority: document.getElementById("editTaskPriority").value,
          startDate: document.getElementById("editTaskStart").value,
          dueDate: document.getElementById("editTaskDue").value,
        };
        await fetch(`http://localhost:3000/tasks/${taskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        closeModal("editTaskModal");
        loadData();
      }

      async function deleteTask() {
        if (!confirm("Permanently delete this task?")) return;
        const taskId = document.getElementById("editTaskId").value;
        await fetch(`http://localhost:3000/tasks/${taskId}`, {
          method: "DELETE",
        });
        closeModal("editTaskModal");
        loadData();
      }

      function openEditBoardModal() {
        document.getElementById("ebTitle").value = boardData.board.boardtitle;
        document.getElementById("ebDesc").value = boardData.board.description;
        document.getElementById("ebTags").value = boardData.board.tags;

        currentLinks = boardData.links.map((l) => ({
          title: l.link_name,
          url: l.link_url,
        }));
        renderLinks();

        document.getElementById("editBoardModal").classList.add("show");
      }

      function addLink() {
        const title = document.getElementById("linkName").value;
        const url = document.getElementById("linkUrl").value;
        if (title && url) {
          currentLinks.push({ title, url });
          renderLinks();
          document.getElementById("linkName").value = "";
          document.getElementById("linkUrl").value = "";
        }
      }

      function removeLink(index) {
        currentLinks.splice(index, 1);
        renderLinks();
      }

      function renderLinks() {
        const div = document.getElementById("linkList");
        div.innerHTML = currentLinks
          .map(
            (l, index) => `
        <span class="link-badge">
          ${l.title}
          <span class="remove-link" onclick="removeLink(${index})">âœ•</span>
        </span>
      `,
          )
          .join("");
      }

      async function saveBoardEdit() {
        await fetch("http://localhost:3000/update-board", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            boardId,
            title: document.getElementById("ebTitle").value,
            description: document.getElementById("ebDesc").value,
            tags: document.getElementById("ebTags").value,
            links: currentLinks,
          }),
        });
        closeModal("editBoardModal");
        loadData();
      }

      function openInviteModal() {
        document.getElementById("inviteModal").classList.add("show");
      }
      async function submitInvite() {
        const email = document.getElementById("inviteEmail").value;
        const res = await fetch("http://localhost:3000/invite-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ boardId, email }),
        });
        const data = await res.json();
        alert(data.msg);
        if (res.ok) {
          closeModal("inviteModal");
          loadData();
        }
      }

      function closeModal(id) {
        document.getElementById(id).classList.remove("show");
      }

      // Initial Load
      loadData();
    </script>
  </body>
</html>
